"use strict";(()=>{var t={};t.id=160,t.ids=[160],t.modules={399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},931:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>T,patchFetch:()=>$,requestAsyncStorage:()=>v,routeModule:()=>y,serverHooks:()=>I,staticGenerationAsyncStorage:()=>b});var r={};a.r(r),a.d(r,{GET:()=>g,dynamic:()=>f,fetchCache:()=>M,revalidate:()=>d,runtime:()=>p});var n=a(9303),o=a(8716),i=a(670);function l(t){return .5*(1+function(t){let e=Math.abs(t),a=1/(1+.3275911*e);return(t<0?-1:1)*(1-((((1.061405429*a+-1.453152027)*a+1.421413741)*a+-.284496736)*a+.254829592)*a*Math.exp(-e*e))}(t/Math.SQRT2))}function s(t,e,a,r,n,o,i){if(i<=0||o<=0)return"C"===t?Math.max(0,e-a):Math.max(0,a-e);let s=Math.sqrt(i),h=(Math.log(e/a)+(r-n+.5*o*o)*i)/(o*s),u=h-o*s;return"C"===t?e*Math.exp(-n*i)*l(h)-a*Math.exp(-r*i)*l(u):a*Math.exp(-r*i)*l(-u)-e*Math.exp(-n*i)*l(-h)}function h(t,e){return e.a+e.b*(e.rho*(t-e.m)+Math.sqrt((t-e.m)**2+e.sigma**2))}let u="https://api.polygon.io";async function m(t){let e=await fetch(t);if(!e.ok)throw Error(`${e.status} ${e.statusText}`);return e.json()}async function c(t){let e=process.env.POLYGON_API_KEY;if(!e)throw Error("POLYGON_API_KEY missing");let a=await m(`${u}/v2/last/trade/${encodeURIComponent(t)}?apiKey=${e}`),r=a?.results?.p??a?.results?.price??0,n=await m(`${u}/v3/reference/options/contracts?underlying_ticker=${encodeURIComponent(t)}&limit=200&apiKey=${e}`),o=Array.from(new Set((n?.results??[]).map(t=>t?.expiration_date?String(t.expiration_date):"").filter(t=>t.length>0))).sort().slice(0,5),i=[];for(let a of o){let n=await m(`${u}/v3/snapshot/options/${encodeURIComponent(t)}?expiration_date=${encodeURIComponent(a)}&contract_type=call&limit=250&apiKey=${e}`),o=n?.results??[];if(!o.length)continue;o.sort((t,e)=>t.details.strike_price-e.details.strike_price);let l=Math.max(0,(o.reduce((t,e,a)=>{let n=Math.abs(e.details.strike_price-r);return n<t.d?{i:a,d:n}:t},{i:0,d:Number.POSITIVE_INFINITY}).i??0)-6),s=o.slice(l,l+13),h=Math.max(1,Math.round((+new Date(a)-Date.now())/864e5))/365;for(let t of s){let e=t.details.strike_price,a=t.day?.bid??t.last_quote?.bid??0,r=t.day?.ask??t.last_quote?.ask??0,n=t.last_trade?.price??0,o=a>0&&r>0?.5*(a+r):n;o>0&&Number.isFinite(e)&&Number.isFinite(h)&&i.push({K:e,T:h,call:o})}}return{spot:r,quotes:i}}let p="nodejs",f="force-dynamic",d=0,M="force-no-store";async function x(t){try{let e=await c(t);if(e&&Array.isArray(e.quotes)&&e.quotes.length)return e}catch{}let e=500,a=Array.from({length:13},(t,e)=>Math.round(400+20*e)),r=[];for(let t of(e*=Math.exp((Math.random()-.5)*.002),[5/365,15/365,30/365,60/365,90/365]))for(let n of a){let a=.2+.08*Math.max(0,(n-e)/e)+.02*(Math.random()-.5),o=s("C",e,n,.02,0,a,t);r.push({K:n,T:t,call:o,iv:a})}return{spot:e,quotes:r}}async function g(t){let e=new TextEncoder,a=[],r=[];return new Response(new ReadableStream({start(n){let o=async()=>{let{spot:t,quotes:o}=await x("SPY");for(let e of o)null==e.iv&&(e.iv=function(t,e,a,r,n,o,i,l=1e-6,h=5,u=80){if(i<=0||o<=0)return 0;for(let t=0;t<u;t++){let t=.5*(l+h);s("C",e,a,.02,0,t,o)>i?h=t:l=t}return .5*(l+h)}(0,t,e.K,0,0,e.T,e.call));let i={};o.forEach(t=>{(i[t.T]??=[]).push(t)});let u={};for(let e of Object.keys(i).map(Number)){let a=i[e],r=a.map(e=>Math.log(e.K/t)),n=a.map(t=>(t.iv??.2)**2*e);u[e]=function(t,e){if(t.length!==e.length||0===e.length)throw Error("fitSVI: inputs must be same nonzero length");let a=Math.max(1e-8,.9*Math.min(...e)),r=t.reduce((t,e)=>t+e,0)/Math.max(1,t.length),n={a:a,b:.1,rho:0,m:r,sigma:.2},o=Number.POSITIVE_INFINITY,i=(t,e,a)=>Array.from({length:a},(r,n)=>t+(e-t)*n/(a-1));for(let l of i(.01,2,8))for(let s of i(-.9,.9,7))for(let u of i(.01,1,8)){let i={a:a,b:l,rho:s,m:r,sigma:u},m=e.reduce((e,a,r)=>{let n=h(t[r],i)-a;return e+n*n},0);m<o&&(n=i,o=m)}for(let a=0;a<200;a++){let a=(Math.random()-.5)*.002,r=(Math.random()-.5)*.01,i=(Math.random()-.5)*.01,l=(Math.random()-.5)*.02,s=(Math.random()-.5)*.01,u={a:Math.max(1e-6,n.a+a),b:Math.max(1e-6,n.b+i),rho:Math.max(-.999,Math.min(.999,n.rho+l)),m:n.m+r,sigma:Math.max(1e-4,n.sigma+s)},m=e.reduce((e,a,r)=>{let n=h(t[r],u)-a;return e+n*n},0);m<o&&(n=u,o=m)}return n}(r,n)}let m=Array.from(new Set(o.map(t=>t.K))).sort((t,e)=>t-e),c=Array.from(new Set(o.map(t=>t.T))).sort((t,e)=>t-e),p=function(t,e,a,r,n,o){let i=[];for(let r of e){let e=o[r];if(e)for(let n of t){let t=Math.sqrt(Math.max(h(Math.log(n/a),e),1e-8)/Math.max(r,1e-6));i.push({k:n,t:Math.round(365*r),iv:t})}}return i}(m,c,t,0,0,u),f=[...function(t){let e=[],a={};for(let e of t)(a[e.T]??=[]).push(e);for(let t of Object.keys(a).map(Number)){let r=a[t].slice().sort((t,e)=>t.K-e.K);for(let a=1;a<r.length-1;a++){let n=r[a-1].K,o=r[a].K,i=r[a+1].K,l=r[a-1].call,s=r[a].call,h=r[a+1].call,u=o-n,m=i-o;if(u<1e-6||m<1e-6)continue;let c=(l+.1*s+h)/2.1,p=m*(c-l)-u*(h-c),f=p>5e-4;e.push({type:"butterfly",expiry:`T=${t.toFixed(3)}`,strikes:[n,o,i],metric:p,flagged:f,detail:`Δ=${p.toExponential(2)} @ [${n}, ${o}, ${i}]`})}}return e}(o.map(({K:t,call:e,T:a})=>({K:t,call:e,T:a}))),...function(t){let e=[],a={};for(let e of t)(a[e.K]??=[]).push(e);for(let t of Object.keys(a).map(Number)){let r=a[t].slice().sort((t,e)=>t.T-e.T);for(let a=0;a<r.length-1;a++){let n=r[a],o=r[a+1],i=o.call+1e-6<n.call,l=n.call-o.call;e.push({type:"calendar",expiry:`${n.T.toFixed(3)}→${o.T.toFixed(3)}`,strikes:[t],metric:l,flagged:i,detail:`Δ=${l.toExponential(2)} @ K=${t}`})}}return e}(o.map(({K:t,call:e,T:a})=>({K:t,call:e,T:a})))];for(let e of(r.length=0,c))for(let a of m){let n=o.find(t=>t.T===e&&t.K===a),i=function(t,e,a,r,n,o,i){if(i<=0||o<=0)return{delta:0,gamma:0,vega:0,theta:0,rho:0};let s=Math.sqrt(i),h=(Math.log(e/a)+(.02+.5*o*o)*i)/(o*s),u=h-o*s,m=Math.exp(-.5*h*h)/Math.sqrt(2*Math.PI),c=Math.exp(-0*i)*l(h),p=-e*m*o*Math.exp(-0*i)/(2*s)-.02*a*Math.exp(-.02*i)*l(u)+n*e*Math.exp(-n*i)*l(h),f=a*i*Math.exp(-r*i)*l(u);return{delta:c,gamma:Math.exp(-n*i)*m/(e*o*s),vega:e*Math.exp(-n*i)*m*s,theta:p,rho:f}}("C",t,a,.02,0,n?.iv??.2,e);r.push({k:a,t:Math.round(365*e),delta:i.delta,gamma:i.gamma,vega:i.vega})}let d=o.filter(e=>Math.abs(e.K-t)===Math.min(...o.map(e=>Math.abs(e.K-t)))).sort((t,e)=>t.T-e.T).map(t=>t.iv??.2)[0]??.2;a.unshift({ts:Date.now(),atmIv:d}),a.length>240&&a.pop();let M=function(t,e=.3,a=8){if(!Array.isArray(t)||0===t.length)return[];Number.isFinite(e)||(e=.3),e=Math.min(1,Math.max(1e-6,e)),a=Math.max(1,Math.floor(a));let r=t.filter(t=>Number.isFinite(t));if(0===r.length)return[];let n=r[0];for(let t=1;t<r.length;t++)n=e*r[t]+(1-e)*n;let o=r.map(t=>t-n),i=Math.max(1,o.length-1),l=Math.sqrt(Math.max(o.reduce((t,e)=>t+e*e,0)/i,1e-12)),s=t=>{let e=Math.max(0,t-1.64*l);return{iv:Math.max(0,t),ci:[e,Math.max(e,t+1.64*l)]}};return Array.from({length:a},(t,e)=>({t:e+1,...s(n)}))}(a.map(t=>t.atmIv),.35,8),g={ts:Date.now(),symbol:"SPY",underlier:{price:t},ivGrid:p,arb:f,forecast:M,history:a.slice(0,120),greeks:r};n.enqueue(e.encode(`data: ${JSON.stringify(g)}

`))},i=setInterval(()=>{o().catch(()=>{})},1500);o().catch(()=>{}),t.signal?.addEventListener("abort",()=>{clearInterval(i);try{n.close()}catch{}})},cancel(){}}),{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache, no-transform",Connection:"keep-alive"}})}let y=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stream/route",pathname:"/api/stream",filename:"route",bundlePath:"app/api/stream/route"},resolvedPagePath:"/Users/ericzhang/Desktop/Projects/Volatix-main/src/app/api/stream/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:b,serverHooks:I}=y,T="/api/stream/route";function $(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:b})}},9303:(t,e,a)=>{t.exports=a(517)}};var e=require("../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),r=e.X(0,[948],()=>a(931));module.exports=r})();